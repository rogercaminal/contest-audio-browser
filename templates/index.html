<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>{{ contest_id }}</title>

    <style>
      body { margin: 0; font-family: system-ui, sans-serif; }
      .page { padding: 1rem; }

      .sticky-player {
        position: sticky;
        top: 0;
        z-index: 1000;
        background: #fff;
        padding: 0.7rem 1rem;
        border-bottom: 1px solid #ddd;
      }

      table { border-collapse: collapse; width: 100%; }
      th, td { border: 1px solid #ccc; padding: 4px 6px; font-size: 0.9rem; }
      th { background: #f3f3f3; }
      tr:hover { background: #eef; cursor: pointer; }

      .selected-range { background: #cde !important; }

      .search-bar {
        margin-bottom: 1rem;
        padding: 0.5rem;
        background: #f5f5f5;
        border: 1px solid #ddd;
        font-size: 0.9rem;
      }

      .search-bar input[type="text"] {
        margin-right: 0.5rem;
        padding: 2px 4px;
      }

      .controls-bar {
        margin-bottom: 1rem;
        font-size: 0.9rem;
      }

      .controls-bar button {
        padding: 3px 8px;
      }
    </style>
  </head>

  <body>

    <div class="sticky-player">
      <h2 style="margin: 0 0 6px 0;">Contest: {{ contest_id }}</h2>
      <audio id="player" controls style="width: 100%;"></audio>
    
      <div class="nav-back" style="margin-top: 8px; margin-bottom: 5px;">
        <a href="{{ url_for('home') }}" style="font-size: 0.95rem; text-decoration: none;">
          â¬… Back to contest list
        </a>
      </div>
    </div>

    <div class="page">

      <!-- Search form -->
      <form method="get"
            class="search-bar"
            action="{{ url_for('contest_view', contest_id=contest_id) }}">
        <label for="call">Callsign:</label>
        <input
          type="text"
          id="call"
          name="call"
          value="{{ call_query or '' }}"
          placeholder="DL1ABC"
        />

        <label for="time_from">From (UTC):</label>
        <input
          type="text"
          id="time_from"
          name="time_from"
          value="{{ time_from_query or '' }}"
          placeholder="YYYY-MM-DD HH:MM"
        />

        <label for="time_to">To (UTC):</label>
        <input
          type="text"
          id="time_to"
          name="time_to"
          value="{{ time_to_query or '' }}"
          placeholder="YYYY-MM-DD HH:MM"
        />

        <button type="submit">Search</button>
        <a href="{{ url_for('contest_view', contest_id=contest_id) }}"
           style="margin-left: 1rem;">Clear</a>
      </form>

      <!-- Selection + download controls -->
      <div class="controls-bar">
        <span id="selection-info">No selection</span>

        <form
          id="download-form"
          action="{{ url_for('contest_download_selection', contest_id=contest_id) }}"
          method="post"
          style="display:inline;"
        >
          <input type="hidden" id="start_index" name="start_index" />
          <input type="hidden" id="end_index" name="end_index" />
          <button type="submit">Download selection</button>
        </form>
      </div>

      <!-- QSO table -->
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Date/Time (UTC)</th>
            <th>Freq</th>
            <th>Mode</th>
            <th>My Call</th>
            <th>DX Call</th>
            <th>Sent</th>
            <th>Rcvd</th>
          </tr>
        </thead>
        <tbody>
          {% for q in qsos %}
          <tr
            data-index="{{ q.index }}"
            onclick="rowClicked(
              '{{ url_for('contest_audio', contest_id=contest_id, filename=q.file) if q.file else '' }}',
              {{ q.file_offset }},
              {{ q.index }}
            )"
          >
            <td>{{ q.index }}</td>
            <td>{{ q.datetime.strftime('%Y-%m-%d %H:%M') }}</td>
            <td>{{ q.freq }}</td>
            <td>{{ q.mode }}</td>
            <td>{{ q.mycall }}</td>
            <td>{{ q.hiscall }}</td>
            <td>{{ q.rst_s }} {{ q.exch_s }}</td>
            <td>{{ q.rst_r }} {{ q.exch_r }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <script>
      function playQSO(url, offset) {
        const audio = document.getElementById("player");

        if (!url) {
          alert("No audio file mapped for this QSO.");
          return;
        }

        const wantedSrc = url;

        if (audio.getAttribute("data-src") !== wantedSrc) {
          audio.src = wantedSrc;
          audio.setAttribute("data-src", wantedSrc);

          const handler = function () {
            audio.currentTime = offset;
            audio.play();
            audio.removeEventListener("loadedmetadata", handler);
          };
          audio.addEventListener("loadedmetadata", handler);
        } else {
          audio.currentTime = offset;
          audio.play();
        }
      }

      // Selection logic
      let selStart = null;
      let selEnd = null;

      function updateSelection() {
        const rows = document.querySelectorAll("tbody tr");
        rows.forEach((r) => {
          const idx = parseInt(r.dataset.index);
          if (
            selStart !== null &&
            selEnd !== null &&
            idx >= selStart &&
            idx <= selEnd
          ) {
            r.classList.add("selected-range");
          } else {
            r.classList.remove("selected-range");
          }
        });

        const info = document.getElementById("selection-info");
        const startInput = document.getElementById("start_index");
        const endInput = document.getElementById("end_index");

        if (selStart !== null && selEnd !== null) {
          info.textContent = `Selected QSOs from #${selStart} to #${selEnd}`;
          startInput.value = selStart;
          endInput.value = selEnd;
        } else if (selStart !== null) {
          info.textContent = `Selection start at #${selStart}. Click another row to set end.`;
          startInput.value = "";
          endInput.value = "";
        } else {
          info.textContent = "No selection";
          startInput.value = "";
          endInput.value = "";
        }
      }

      function rowClicked(audioUrl, offset, index) {
        // selection handling
        if (selStart === null) {
          selStart = index;
          selEnd = null;
        } else if (selEnd === null) {
          if (index >= selStart) {
            selEnd = index;
          } else {
            selEnd = selStart;
            selStart = index;
          }
        } else {
          selStart = index;
          selEnd = null;
        }

        updateSelection();
        playQSO(audioUrl, offset);
      }

      updateSelection();
    </script>

  </body>
</html>

